"use strict";var __awaiter=this&&this.__awaiter||function(t,h,a,l){return new(a=a||Promise)(function(i,e){function n(t){try{o(l.next(t))}catch(t){e(t)}}function r(t){try{o(l.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?i(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(n,r)}o((l=l.apply(t,h||[])).next())})},__generator=this&&this.__generator||function(i,n){var r,o,h,a={label:0,sent:function(){if(1&h[0])throw h[1];return h[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(h=2&e[0]?o.return:e[0]?o.throw||((h=o.return)&&h.call(o),0):o.next)&&!(h=h.call(o,e[1])).done)return h;switch(o=0,(e=h?[2&e[0],h.value]:e)[0]){case 0:case 1:h=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,o=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(h=0<(h=a.trys).length&&h[h.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!h||e[1]>h[0]&&e[1]<h[3])){a.label=e[1];break}if(6===e[0]&&a.label<h[1]){a.label=h[1],h=e;break}if(h&&a.label<h[2]){a.label=h[2],a.ops.push(e);break}h[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(i,a)}catch(t){e=[6,t],o=0}finally{r=h=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.frameToPngFile=exports.BubbleDefinition=void 0;var canvas_1=require("canvas"),fs_1=require("fs"),bubble_1=require("./bubble"),conversions_1=require("./conversions"),BubbleDefinition=function(){function t(t,e){var i=e.exitPosition,n=e.radius,e=e.thickness;this.burstAngles=[],this.animationParams=t;var r=this.animationParams.burst.particleCount;this.exitPosition=i,this.radius=n,this.thickness=e,this.stepRatio=0;for(var o=2*Math.PI,h=o/r,a=0;a<r;a++){var l=a*h+(2*Math.random()-1)*(h/3);l<0&&(l+=o),o<l&&(l-=o),this.burstAngles.push(l)}}return t.prototype.step=function(t){this.stepRatio=t},t}();exports.BubbleDefinition=BubbleDefinition;var frameToPngFile=function(y,t,k){var P=t.resolution,I=t.orientation,S=t.margins,B=t.flask,C=t.text,R=t.bubbles,T=t.animationParams,q=t.backgroundColor;return __awaiter(void 0,void 0,void 0,function(){var h,a,l,s,f,u,c,g,d,p,w,b,m,v,_,x;return __generator(this,function(t){var e,i,n,r,o;return m={width:(u=function(t){return t/k.flask.dimensions.height*100})(k.flask.dimensions.width),height:u(k.flask.dimensions.height)},h={width:u(k.text.dimensions.width)*C.scale,height:u(k.text.dimensions.height)*C.scale},e=S.bottom,i=S.gap,n=S.left,r=S.right,o=S.top,a="under"===I?{width:n+h.width+r,height:o+m.height+i+h.height+e}:{width:n+m.width+i+h.width+r,height:o+m.height+e},l=(0,conversions_1.genUnitConverter)(P.height,a.height),s=(0,canvas_1.createCanvas)(l(a.width),l(a.height)),f=s.getContext("2d"),p={left:0,top:0},u={left:0,top:0,width:0,height:0},"under"===I?(p.left=(a.width-m.width)/2+B.horizontalOffset,p.top=S.top,b=l(p.left),c=l(p.top),v=l(m.width),_=l(m.height),u={left:b,top:c,width:v,height:_}):"left"===I?(p.left=S.left+h.width+S.gap,p.top=S.top,b=l(p.left),c=l(p.top),v=l(m.width),_=l(m.height),u={left:b,top:c,width:v,height:_}):"right"===I&&(p.left=S.left,p.top=S.top,b=l(p.left),d=l(p.top),v=l(m.width),_=l(m.height),u={left:b,top:d,width:v,height:_}),g={x:p.left+m.width/2,y:p.top},q&&(f.fillStyle=q,f.fillRect(0,0,s.width,s.height)),R.forEach(function(t){(0,bubble_1.drawBubble)(f,g,l,t,T)}),b=u.left,d=u.top,v=u.width,_=u.height,p=.01*_,q?(f.fillStyle=q,f.fillRect(b,d+p,v,_-p)):f.clearRect(b,d+p,v,_-p),"under"===I?(b=u.left,p=u.top,v=u.width,_=u.height,f.drawImage(k.flask.image,b,p,v,_),b=l(S.left),p=l(S.top+m.height+S.gap),v=l(h.width),_=l(h.height),f.drawImage(k.text.image,b,p,v,_)):"left"===I?(b=u.left,w=u.top,v=u.width,_=u.height,f.drawImage(k.flask.image,b,w,v,_),b=l(S.left),w=l(S.top+m.height/2-h.height/2+C.verticalOffset),v=l(h.width),_=l(h.height),f.drawImage(k.text.image,b,w,v,_)):"right"===I&&(b=u.left,w=u.top,v=u.width,_=u.height,f.drawImage(k.flask.image,b,w,v,_),b=l(S.left+m.width+S.gap),m=l(S.top+m.height/2-h.height/2+C.verticalOffset),v=l(h.width),_=l(h.height),f.drawImage(k.text.image,b,m,v,_)),x=(0,fs_1.createWriteStream)(y),[2,new Promise(function(t){s.createPNGStream().pipe(x),x.on("finish",function(){t(!0)})})]})})};exports.frameToPngFile=frameToPngFile;